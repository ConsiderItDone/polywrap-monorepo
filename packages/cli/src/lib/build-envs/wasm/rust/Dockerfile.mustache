FROM rust:{{rust_version}}

WORKDIR /project

# Copy all manifest files
{{#web3api_manifests}}
COPY {{.}} .
{{/web3api_manifests}}

# Copy all source files
{{#include}}
COPY {{.}} {{.}}
{{/include}}
{{#web3api_modules}}
COPY {{dir}} {{dir}}
{{/web3api_modules}}

{{#web3api_modules}}
# Build the module at {{dir}}
RUN cargo build --path {{dir}}/w3/ \
    --target wasm32-unknown-unknown

# Use wasm-opt to add Asyncify support
RUN wasm-opt -O2 --asyncify ./target/wasm32/{{name}}.wasm

{{/web3api_modules}}
